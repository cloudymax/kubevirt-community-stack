{{- if eq .Values.cluster.provider "k3s" }}
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KThreesControlPlane
metadata:
  name: {{ .Values.cluster.name }}-control-plane
  namespace: {{ .Values.cluster.namespace }}
spec:
  infrastructureTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: KubevirtMachineTemplate
    name: {{ .Values.cluster.name }}-control-plane
  replicas: {{ .Values.controlPlane.size }}
  version: {{ .Values.cluster.version }}

spec:
  kthreesConfigSpec:
    files:
     {{- if .Values.cluster.kubeletConfigFile.enabled }}
     {{- $content := .Values.cluster.kubeletConfigFile.content }}
      - path: /etc/kubernetes/kubelet.yaml
        permissions: "0640"
        content: |-
          {{- $content | nindent 10 }}
    {{- end }}
    {{- with .Values.cluster.preCommands }}
    preK3sCommands:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    postK3sCommands: []
    serverConfig:
      disableCloudController: false
      kubeAPIServerArg: []
      kubeControllerManagerArgs: []
      kubeSchedulerArgs: []
      tlsSan: []
      advertiseAddress: ""
      advertisePort: ""
      clusterCidr: 10.10.0.0/16
      serviceCidr: 10.11.0.0/16
      clusterDNS: ""
      clusterDomain: "cluster.local"
      cloudProviderName: external
      disableComponents:
        - servicelb
        - traefik
      httpsListenPort: ""
    agentConfig:
      kubeProxyArgs: []
      kubeletArgs:
        - --config=/etc/kubernetes/kubelet.yaml
      nodeLabels: []
      nodeName: ""
      nodeTaints: []
      privateRegistry: ""
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
      kind: KubevirtMachineTemplate
      name: capi-control-plane
  replicas: 1
  version: v1.32.1+k3s1
{{- end }}
